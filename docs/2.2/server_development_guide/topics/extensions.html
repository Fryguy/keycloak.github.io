<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Server Developer Guide -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Extending Server | Server Developer Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../topics/auth-spi.html" />
    
    
    <link rel="prev" href="../topics/providers.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="6"
        data-chapter-title="Extending Server"
        data-filepath="topics/extensions.adoc"
        data-basepath=".."
        data-revision="Wed Feb 08 2017 07:51:58 GMT+0100 (CET)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="topics/preface.html">
            
                
                    <a href="../topics/preface.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="topics/admin-rest-api.html">
            
                
                    <a href="../topics/admin-rest-api.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Admin REST API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="topics/themes.html">
            
                
                    <a href="../topics/themes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Themes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="topics/custom-attributes.html">
            
                
                    <a href="../topics/custom-attributes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Custom User Attributes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="topics/providers.html">
            
                
                    <a href="../topics/providers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Service Provider Interfaces (SPI)
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="6" data-path="topics/extensions.html">
            
                
                    <a href="../topics/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Extending Server
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="topics/auth-spi.html">
            
                
                    <a href="../topics/auth-spi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Authentication SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="topics/events.html">
            
                
                    <a href="../topics/events.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Event Listener SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="topics/user-federation.html">
            
                
                    <a href="../topics/user-federation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        User Federation SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="topics/user-federation-mapper.html">
            
                
                    <a href="../topics/user-federation-mapper.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        User Federation Mapper SPI
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Server Developer Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <div class="sect1">
<h2 id="_extensions">Extending the Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Keycloak SPI framework offers the possibility to implement or override particular built-in providers. However Keycloak
also provides capabilities to extend it&#x2019;s core functionalities and domain. This includes possibilities to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add custom REST endpoints to the Keycloak server</p>
</li>
<li>
<p>Add your own custom SPI</p>
</li>
<li>
<p>Add custom JPA entities to the Keycloak data model</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_extensions_rest">Add custom REST endpoints</h3>
<div class="paragraph">
<p>This is a very powerful extension, which allows you to deploy your own REST endpoints to the Keycloak server. It enables all kinds of extensions, for example
the possibility to trigger functionality on the Keycloak server, which is not available through the default set of built-in Keycloak REST endpoints.</p>
</div>
<div class="paragraph">
<p>To add a custom REST endpoint, you need to implement the <code>RealmResourceProviderFactory</code> and <code>RealmResourceProvider</code> interfaces. <code>RealmResourceProvider</code> has one important method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-function">Object <span class="hljs-title">getResource</span><span class="hljs-params">()</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>which allows you to return an object, which acts as a <a href="https://jax-rs-spec.java.net/" target="_blank">JAX-RS Resource</a>. For more details, see the Javadoc and our examples.
There is a very simple example in the example distribution in <code>providers/rest</code> and there is a more advanced example in <code>providers/domain-extension</code>,
which shows how to add an authenticated REST endpoint and other functionalities like <a href="extensions.html#_extensions_spi">Adding your own SPI</a>
or <a href="extensions.html#_extensions_jpa">Extending datamodel with your own JPA entities</a>.</p>
</div>
<div class="paragraph">
<p>For details on how to package and deploy a custom provider, refer to the <a href="providers.html#_providers">Service Provider Interfaces</a> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensions_spi">Add your own custom SPI</h3>
<div class="paragraph">
<p>This is useful especially with the <a href="extensions.html#_extensions_rest">Custom REST endpoints</a>. To add your own kind of SPI, you need to
implement the interface <code>org.keycloak.provider.Spi</code> and define the ID of your SPI and the <code>ProviderFactory</code> and <code>Provider</code> classes. That looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">package</span> org.keycloak.examples.domainextension.spi;

<span class="hljs-keyword">import</span> ...

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleSpi</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Spi</span> </span>{

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInternal</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;example&quot;</span>;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;? extends Provider&gt; getProviderClass() {
        <span class="hljs-keyword">return</span> ExampleService.class;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-annotation">@SuppressWarnings</span>(<span class="hljs-string">&quot;rawtypes&quot;</span>)
    <span class="hljs-keyword">public</span> Class&lt;? extends ProviderFactory&gt; getProviderFactoryClass() {
        <span class="hljs-keyword">return</span> ExampleServiceProviderFactory.class;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to create the file <code>META-INF/services/org.keycloak.provider.Spi</code> and add the class of your SPI to it. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>org.keycloak.examples.domainextension.spi.ExampleSpi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the interfaces <code>ExampleServiceProviderFactory</code>, which extends from <code>ProviderFactory</code> and <code>ExampleService</code>, which extends from <code>Provider</code>.
The <code>ExampleService</code> will usually contain the business methods you need for your use case. Note that the <code>ExampleServiceProviderFactory</code> instance
is always scoped per application, however <code>ExampleService</code> is scoped per-request (or more accurately per <code>KeycloakSession</code> lifecycle).</p>
</div>
<div class="paragraph">
<p>Finally you need to implement your providers in the same manner as described in the <a href="providers.html#_providers">Service Provider Interfaces</a> chapter.</p>
</div>
<div class="paragraph">
<p>For more details, take a look at the example distribution at <code>providers/domain-extension</code>, which shows an Example SPI similar to the one above.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensions_jpa">Add custom JPA entities to the Keycloak data model</h3>
<div class="paragraph">
<p>If the Keycloak data model does not exactly match your desired solution, or if you want to add some core functionality to Keycloak,
or when you have your own REST endpoint, you might want to extend the Keycloak data model. We enable you to add your
own JPA entities to the Keycloak JPA <code>EntityManager</code> .</p>
</div>
<div class="paragraph">
<p>To add your own JPA entities, you need to implement <code>JpaEntityProviderFactory</code> and <code>JpaEntityProvider</code>. The <code>JpaEntityProvider</code>
allows you to return a list of your custom JPA entities and provide the location and id of the liquibase changelog. An example implementation can look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleJpaEntityProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JpaEntityProvider</span> </span>{

    <span class="hljs-comment">// List of your JPA entities.</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Class&lt;?&gt;&gt; getEntities() {
        <span class="hljs-keyword">return</span> Collections.&lt;Class&lt;?&gt;&gt;singletonList(Company.class);
    }

    <span class="hljs-comment">// This is used to return the location of the Liquibase changelog file.</span>
    <span class="hljs-comment">// You can return null if you don&apos;t want Liquibase to create and update the DB schema.</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getChangelogLocation</span><span class="hljs-params">()</span> </span>{
    	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;META-INF/example-changelog.xml&quot;</span>;
    }

    <span class="hljs-comment">// Helper method, which will be used internally by Liquibase.</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFactoryId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;sample&quot;</span>;
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, we added a single JPA entity represented by class <code>Company</code>. In the code of your REST endpoint, you can then use something like
this to retrieve <code>EntityManager</code> and call DB operations on it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EntityManager em = session.getProvider(JpaConnectionProvider.class).getEntityManager();
Company myCompany = em.find(Company.class, <span class="hljs-string">&quot;123&quot;</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The methods <code>getChangelogLocation</code> and <code>getFactoryId</code> are important to support automatic updating of your entities by Liquibase. <a href="http://www.liquibase.org/" target="_blank">Liquibase</a>
is a framework for updating the database schema, which Keycloak internally uses to create the DB schema and update the DB schema among versions. You may need to use
it as well and create a changelog for your entities. Note that versioning of your own liquibase changelog is independent
of Keycloak versions. In other words, when you update to a new Keycloak version, you are not forced to update your
schema at the same time. And vice versa, you can update your schema even without updating the Keycloak version. The Liquibase update
is always done at the server startup, so to trigger a DB update of your schema, you just need to add the new changeset to your liquibase changelog file (in the example above
it&#x2019;s the file <code>META-INF/example-changelog.xml</code> (which must be packed in same JAR as the JPA entities and <code>ExampleJpaEntityProvider</code>) and then restart server.
The DB schema will be automatically updated at startup.</p>
</div>
<div class="paragraph">
<p>For more details, take a look at the example distribution at example <code>providers/domain-extension</code>, which shows the <code>ExampleJpaEntityProvider</code> and <code>example-changelog.xml</code> described above.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Don&#x2019;t forget to always backup your database before doing any changes in the Liquibase changelog and triggering a DB update.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../topics/providers.html" class="navigation navigation-prev " aria-label="Previous page: Service Provider Interfaces (SPI)"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../topics/auth-spi.html" class="navigation navigation-next " aria-label="Next page: Authentication SPI"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-ungrey/ungrey.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"toggle-chapters":{},"ungrey":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Server Developer Guide -->
</html>
