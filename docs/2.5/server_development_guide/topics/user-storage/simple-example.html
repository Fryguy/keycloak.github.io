<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Server Developer Guide -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Simple Read-Only, Lookup Example | Server Developer Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../topics/user-storage/configuration.html" />
    
    
    <link rel="prev" href="../../topics/user-storage/packaging.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="9.5"
        data-chapter-title="Simple Read-Only, Lookup Example"
        data-filepath="topics/user-storage/simple-example.adoc"
        data-basepath="../.."
        data-revision="Wed Feb 08 2017 07:51:10 GMT+0100 (CET)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="topics/preface.html">
            
                
                    <a href="../../topics/preface.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="topics/admin-rest-api.html">
            
                
                    <a href="../../topics/admin-rest-api.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Admin REST API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="topics/themes.html">
            
                
                    <a href="../../topics/themes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Themes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="topics/custom-attributes.html">
            
                
                    <a href="../../topics/custom-attributes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Custom User Attributes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="topics/providers.html">
            
                
                    <a href="../../topics/providers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Service Provider Interfaces (SPI)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="topics/extensions.html">
            
                
                    <a href="../../topics/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Extending Server
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="topics/auth-spi.html">
            
                
                    <a href="../../topics/auth-spi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Authentication SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="topics/events.html">
            
                
                    <a href="../../topics/events.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Event Listener SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="topics/user-storage.html">
            
                
                    <a href="../../topics/user-storage.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        User Storage SPI
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="9.1" data-path="topics/user-storage/provider-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                        Provider Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="topics/user-storage/provider-capability-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-capability-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                        Provider Capability Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.3" data-path="topics/user-storage/model-interfaces.html">
            
                
                    <a href="../../topics/user-storage/model-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                        Model Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.4" data-path="topics/user-storage/packaging.html">
            
                
                    <a href="../../topics/user-storage/packaging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.4.</b>
                        
                        Packaging and Deployment
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="9.5" data-path="topics/user-storage/simple-example.html">
            
                
                    <a href="../../topics/user-storage/simple-example.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.5.</b>
                        
                        Simple Read-Only, Lookup Example
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.6" data-path="topics/user-storage/configuration.html">
            
                
                    <a href="../../topics/user-storage/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.6.</b>
                        
                        Configuration Techniques
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.7" data-path="topics/user-storage/registration-query.html">
            
                
                    <a href="../../topics/user-storage/registration-query.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.7.</b>
                        
                        Add/Remove User and Query Capability interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.8" data-path="topics/user-storage/augmenting.html">
            
                
                    <a href="../../topics/user-storage/augmenting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.8.</b>
                        
                        Augmenting External Storage
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.9" data-path="topics/user-storage/import.html">
            
                
                    <a href="../../topics/user-storage/import.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.9.</b>
                        
                        Import Implementation Strategy
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.10" data-path="topics/user-storage/cache.html">
            
                
                    <a href="../../topics/user-storage/cache.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.10.</b>
                        
                        User Caches
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.11" data-path="topics/user-storage/javaee.html">
            
                
                    <a href="../../topics/user-storage/javaee.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.11.</b>
                        
                        Leveraging Java EE
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.12" data-path="topics/user-storage/rest.html">
            
                
                    <a href="../../topics/user-storage/rest.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.12.</b>
                        
                        REST Management API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.13" data-path="topics/user-storage/migration.html">
            
                
                    <a href="../../topics/user-storage/migration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.13.</b>
                        
                        Migrating from an Earlier User Federation SPI
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Server Developer Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <div class="sect2">
<h3 id="_simple_read_only_lookup_example">Simple Read-Only, Lookup Example</h3>
<div class="paragraph">
<p>To illustrate the basics of implementing the User Storage SPI let&#x2019;s walk through a simple example.  In this chapter
you&#x2019;ll see the implementation of a simple <code>UserStorageProvider</code> that looks up users in a simple property file. The
property file contains username and password definitions and is hardcoded to a specific location on the classpath.
The provider will be able to lookup the user by id and username and also be able to validate passwords. Users that
originate from this provider will be read only.</p>
</div>
<div class="sect3">
<h4 id="_provider_class">Provider Class</h4>
<div class="paragraph">
<p>The first thing we will walk through is the <code>UserStorageProvider</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PropertyFileUserStorageProvider</span> <span class="hljs-keyword">implements</span>
        <span class="hljs-title">UserStorageProvider</span>,
        <span class="hljs-title">UserLookupProvider</span>,
        <span class="hljs-title">CredentialInputValidator</span>,
        <span class="hljs-title">CredentialInputUpdater</span>
</span>{
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our provider class, <code>PropertyFileUserStorageProvider</code>, implements a bunch of interfaces. It implements the
<code>UserStorageProvider</code> as that is a base requirement of the SPI. It implements the <code>UserLookupProvider</code> interface
because we want to be able to login with users stored by this provider.  It implements the <code>CredentialInputValidator</code>
interface because we want to be able to validate passwords entered in via the login screen. Our property file
is going to be read only. We implement the <code>CredentialInputUpdater</code> because was want to post an error condition
when the user&#x2019;s password is attempted to be updated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-keyword">protected</span> KeycloakSession session;
    <span class="hljs-keyword">protected</span> Properties properties;
    <span class="hljs-keyword">protected</span> ComponentModel model;
    <span class="hljs-comment">// map of loaded users in this transaction</span>
    <span class="hljs-keyword">protected</span> Map&lt;String, UserModel&gt; loadedUsers = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PropertyFileUserStorageProvider</span><span class="hljs-params">(KeycloakSession session, ComponentModel model, Properties properties)</span> </span>{
        <span class="hljs-keyword">this</span>.session = session;
        <span class="hljs-keyword">this</span>.model = model;
        <span class="hljs-keyword">this</span>.properties = properties;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor for this provider class is going to store the reference to the <code>KeycloakSession</code>, <code>ComponentModel</code>, and
property file. We&#x2019;ll use all of these later. Also notice that there is a map of loaded users. Whenever we find a user
we will store it in this map so that we avoid recreating it again within the same transaction. This is a good practice
to do as many providers will need to do this (i.e., one that integrates with JPA). Remember also that provider class
instances are created once per transaction and are closed after the transaction completes.</p>
</div>
<div class="sect4">
<h5 id="_userlookupprovider_implementation">UserLookupProvider implementation</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserModel <span class="hljs-title">getUserByUsername</span><span class="hljs-params">(String username, RealmModel realm)</span> </span>{
        UserModel adapter = loadedUsers.get(username);
        <span class="hljs-keyword">if</span> (adapter == <span class="hljs-keyword">null</span>) {
            String password = properties.getProperty(username);
            <span class="hljs-keyword">if</span> (password != <span class="hljs-keyword">null</span>) {
                adapter = createAdapter(realm, username);
                loadedUsers.put(username, adapter);
            }
        }
        <span class="hljs-keyword">return</span> adapter;
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> UserModel <span class="hljs-title">createAdapter</span><span class="hljs-params">(RealmModel realm, String username)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AbstractUserAdapter(session, realm, model) {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> username;
            }
        };
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserModel <span class="hljs-title">getUserById</span><span class="hljs-params">(String id, RealmModel realm)</span> </span>{
        StorageId storageId = <span class="hljs-keyword">new</span> StorageId(id);
        String username = storageId.getExternalId();
        <span class="hljs-keyword">return</span> getUserByUsername(username, realm);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserModel <span class="hljs-title">getUserByEmail</span><span class="hljs-params">(String email, RealmModel realm)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getUserByUsername()</code> method is invoked by the Keycloak login page when a user logs in.  In our
implementation we first check the <code>loadedUsers</code> map to see if the user has already been loaded within this transaction.
If it hasn&#x2019;t been loaded we look in the property file for the username.   If it exists we create an implementation
of <code>UserModel</code>, store it in <code>loadedUsers</code> for future reference and return this instance.</p>
</div>
<div class="paragraph">
<p>The <code>createAdapter()</code> method uses the helper class <code>org.keycloak.storage.adapter.AbstractUserAdapter</code>.  This provides
a base implementation for <code>UserModel</code>.  It automatically generates a user id based on the required storage id format
using the username of the user as the external id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&quot;f:&quot; + component id + &quot;:&quot; + username</pre>
</div>
</div>
<div class="paragraph">
<p>Every get method of <code>AbstractUserAdapter</code> either returns null or empty collections.  However, methods that return
role and group mappings will return the default roles and groups configured for the realm for every user.  Every set
method of <code>AbstractUserAdapter</code> will throw a <code>org.keycloak.storage.ReadOnlyException</code>.  So if you attempt
to modify the user in the admin console you will get an error.</p>
</div>
<div class="paragraph">
<p>The <code>getUserById()</code> method parses the <code>id</code> parameter using the <code>org.keycloak.storage.StorageId&apos; helper class.  The
`StorageId.getExternalId()</code> method is invoked to obtain the username embeded in the <code>id</code> parameter.  The method
then delegates to <code>getUserByUsername()</code>.</p>
</div>
<div class="paragraph">
<p>Emails are not stored at all, so the `getUserByEmail() method</p>
</div>
</div>
<div class="sect4">
<h5 id="_credentialinputvalidator_implementation">CredentialInputValidator implementation</h5>
<div class="paragraph">
<p>Next let&#x2019;s look at the method implementations for <code>CredentialInputValidator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isConfiguredFor</span><span class="hljs-params">(RealmModel realm, UserModel user, String credentialType)</span> </span>{
        String password = properties.getProperty(user.getUsername());
        <span class="hljs-keyword">return</span> credentialType.equals(CredentialModel.PASSWORD) &amp;&amp; password != <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supportsCredentialType</span><span class="hljs-params">(String credentialType)</span> </span>{
        <span class="hljs-keyword">return</span> credentialType.equals(CredentialModel.PASSWORD);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(RealmModel realm, UserModel user, CredentialInput input)</span> </span>{
        <span class="hljs-keyword">if</span> (!supportsCredentialType(input.getType()) || !(input <span class="hljs-keyword">instanceof</span> UserCredentialModel)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

        UserCredentialModel cred = (UserCredentialModel)input;
        String password = properties.getProperty(user.getUsername());
        <span class="hljs-keyword">if</span> (password == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">return</span> password.equals(cred.getValue());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>isConfiguredFor()</code> method is called by the runtime to determine if a specific credential type is configured for
the user.  This method checks to see that the password is set for the user.</p>
</div>
<div class="paragraph">
<p>The <code>suportsCredentialType()</code> method returns whether validation is supported for a specific credential type.  We check
to see if the credential type is <code>password</code>.</p>
</div>
<div class="paragraph">
<p>The <code>isValid()</code> method is responsible for validating passwords.  The <code>CredentialInput</code> parameter is really just an abstract
interface for all credential types.  We make sure that we support the credential type and also that it is an instance
of <code>UserCredentialModel</code>.  When a user logs in through the login page, the plain text of the password input is put into
an instance of <code>UserCredentialModel</code>.  The <code>isValid()</code> method checks this value against the plain text password stored
in the properties file.  A return value of <code>true</code> means the password is valid.</p>
</div>
</div>
<div class="sect4">
<h5 id="_credentialinputupdater_implementation">CredentialInputUpdater implementation</h5>
<div class="paragraph">
<p>As noted before, the only reason we implement the <code>CredentialInputUpdater</code> interface in this example is to forbid modifications of
user passwords.  The reason we have to do this is because otherwise the runtime would allow the password to be overriden
in Keycloak local storage. We&#x2019;ll talk more about this later in this chapter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">updateCredential</span><span class="hljs-params">(RealmModel realm, UserModel user, CredentialInput input)</span> </span>{
        <span class="hljs-keyword">if</span> (input.getType().equals(CredentialModel.PASSWORD)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ReadOnlyException(<span class="hljs-string">&quot;user is read only for this update&quot;</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disableCredentialType</span><span class="hljs-params">(RealmModel realm, UserModel user, String credentialType)</span> </span>{

    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title">getDisableableCredentialTypes</span><span class="hljs-params">(RealmModel realm, UserModel user)</span> </span>{
        <span class="hljs-keyword">return</span> Collections.EMPTY_SET;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>updateCredential()</code> method just checks to see if the credential type is password.  If it is, a <code>ReadOnlyException</code>
is thrown.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_provider_factory_implementation">Provider Factory implementation</h4>
<div class="paragraph">
<p>Now that the provider class is complete, we now turn our attention to the provider factory class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PropertyFileUserStorageProviderFactory</span>
                 <span class="hljs-keyword">implements</span> <span class="hljs-title">UserStorageProviderFactory</span>&lt;<span class="hljs-title">PropertyFileUserStorageProvider</span>&gt; </span>{

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PROVIDER_NAME = <span class="hljs-string">&quot;readonly-property-file&quot;</span>;

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> PROVIDER_NAME;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>First thing to notice is that when implementing the <code>UserStorageProviderFactory</code> class, you must pass in the concrete
provider class implementation as a template parameter.  Here we specify the provider class we defined before: <code>PropertyFileUserStorageProvider</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you do not specify the template parameter, your provider will not function.  The runtime does class introspection
         to determine the <em>capability interfaces</em> that the provider implements.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>getId()</code> method identifies the factory in the runtime and will also be the string shown in the admin console when you want
to enable a user storage provider for the realm.</p>
</div>
<div class="sect4">
<h5 id="_initialization">Initialization</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = Logger.getLogger(PropertyFileUserStorageProviderFactory.class);
    <span class="hljs-keyword">protected</span> Properties properties = <span class="hljs-keyword">new</span> Properties();

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(Config.Scope config)</span> </span>{
        InputStream is = getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;/users.properties&quot;</span>);

        <span class="hljs-keyword">if</span> (is == <span class="hljs-keyword">null</span>) {
            logger.warn(<span class="hljs-string">&quot;Could not find users.properties in classpath&quot;</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">try</span> {
                properties.load(is);
            } <span class="hljs-keyword">catch</span> (IOException ex) {
                logger.error(<span class="hljs-string">&quot;Failed to load users.properties file&quot;</span>, ex);
            }
        }
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PropertyFileUserStorageProvider <span class="hljs-title">create</span><span class="hljs-params">(KeycloakSession session, ComponentModel model)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyFileUserStorageProvider(session, model, properties);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>UserStorageProviderFactory</code> interface has an optional <code>init()</code> method you can implement.  When Keycloak
boots up, one and only one instance of each different provider factory.  Also at boot time, the <code>init()</code> method will
be called on each one of these factory instances.  There&#x2019;s also a <code>postInit()</code> method you can implement as well.  After
each factory&#x2019;s <code>init()</code> method is invoked, their <code>postInit()</code> methods will be called.</p>
</div>
<div class="paragraph">
<p>In our <code>init()</code> method implementation, we find the property file containing our user declarations from the classpath.
We then load the <code>properties</code> field with the username and password combinations stored there.</p>
</div>
<div class="paragraph">
<p>The <code>Config.Scope</code> parameter is factory configuration that can be set up
within <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code>.
For more information on where the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file resides see the <a href="https://keycloak.gitbooks.io/server-installation-and-configuration/content/" target="_blank">Server Installation and Configuration Guide</a>.</p>
</div>
<div class="paragraph">
<p>For example, by adding the following to <code>standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"><span class="hljs-tag">&lt;<span class="hljs-title">spi</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">&quot;storage&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">provider</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">&quot;readonly-property-file&quot;</span> <span class="hljs-attribute">enabled</span>=<span class="hljs-value">&quot;true&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">&quot;path&quot;</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">&quot;/other-users.properties&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">provider</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">spi</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can specify the classpath of the user property file instead of hard coded it.
Then you can retrieve the config in the <code>PropertyFileUserStorageProviderFactory.init()</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(Config.Scope config)</span> </span>{
    String path = config.get(<span class="hljs-string">&quot;path&quot;</span>);
    InputStream is = getClass().getClassLoader().getResourceAsStream(path);

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_create_method">Create method</h5>
<div class="paragraph">
<p>Our last step in creating the provider factory is the <code>create()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PropertyFileUserStorageProvider <span class="hljs-title">create</span><span class="hljs-params">(KeycloakSession session, ComponentModel model)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyFileUserStorageProvider(session, model, properties);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We simply allocate the <code>PropertyFileUserStorageProvider</code> class.  This create method will be called once per transaction.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_packaging_and_deployment">Packaging and Deployment</h4>
<div class="paragraph">
<p>The class files for our provider implementation should be placed in a jar.  You also have to declare the provider
factory class within the <code>META-INF/services/org.keycloak.storage.UserStorageProviderFactory</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.keycloak.examples.federation.properties.FilePropertiesStorageFactory</pre>
</div>
</div>
<div class="paragraph">
<p>Once you create the jar you can deploy it using regular JBoss/Wildfly means:  copy the jar into the <code>deploy/</code> directory
or using the JBoss CLI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_the_provider_in_admin_console">Enabling the Provider in Admin Console</h4>
<div class="paragraph">
<p>You enable user storage providers per realm within the <code>User Federation</code> page in the admin console.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="../../keycloak-images/empty-user-federation-page.png" alt="empty-user-federation-page.png"></span></p>
</div>
<div class="paragraph">
<p>Select the provider we just created from the list: <code>readonly-property-file</code>.  It brings you to the configuration
page for our provider.  We don&#x2019;t have anything to configure, so just click the <code>Save</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Configured Provider</div>
<p><span class="image"><img src="../../keycloak-images/storage-provider-created.png" alt="storage-provider-created.png"></span></p>
</div>
<div class="paragraph">
<p>When you go back to the main <code>User Federation</code> page, you&#x2019;ll now see your provider listed.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="../../keycloak-images/user-federation-page.png" alt="user-federation-page.png"></span></p>
</div>
<div class="paragraph">
<p>You will now be able to login with a user declared in the <code>users.properties</code> file.  Of course, this user will have
zero permissions to do anything and will be read only.  You can though view the user on its account page after you
login.</p>
</div>
</div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../topics/user-storage/packaging.html" class="navigation navigation-prev " aria-label="Previous page: Packaging and Deployment"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../topics/user-storage/configuration.html" class="navigation navigation-next " aria-label="Next page: Configuration Techniques"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-ungrey/ungrey.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"toggle-chapters":{},"ungrey":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Server Developer Guide -->
</html>
