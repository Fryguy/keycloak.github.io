<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Server Developer Guide -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Import Implementation Strategy | Server Developer Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../topics/user-storage/cache.html" />
    
    
    <link rel="prev" href="../../topics/user-storage/augmenting.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="9.9"
        data-chapter-title="Import Implementation Strategy"
        data-filepath="topics/user-storage/import.adoc"
        data-basepath="../.."
        data-revision="Wed Feb 08 2017 07:51:10 GMT+0100 (CET)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="topics/preface.html">
            
                
                    <a href="../../topics/preface.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="topics/admin-rest-api.html">
            
                
                    <a href="../../topics/admin-rest-api.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Admin REST API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="topics/themes.html">
            
                
                    <a href="../../topics/themes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Themes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="topics/custom-attributes.html">
            
                
                    <a href="../../topics/custom-attributes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Custom User Attributes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="topics/providers.html">
            
                
                    <a href="../../topics/providers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Service Provider Interfaces (SPI)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="topics/extensions.html">
            
                
                    <a href="../../topics/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Extending Server
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="topics/auth-spi.html">
            
                
                    <a href="../../topics/auth-spi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Authentication SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="topics/events.html">
            
                
                    <a href="../../topics/events.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Event Listener SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="topics/user-storage.html">
            
                
                    <a href="../../topics/user-storage.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        User Storage SPI
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="9.1" data-path="topics/user-storage/provider-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                        Provider Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="topics/user-storage/provider-capability-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-capability-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                        Provider Capability Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.3" data-path="topics/user-storage/model-interfaces.html">
            
                
                    <a href="../../topics/user-storage/model-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                        Model Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.4" data-path="topics/user-storage/packaging.html">
            
                
                    <a href="../../topics/user-storage/packaging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.4.</b>
                        
                        Packaging and Deployment
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.5" data-path="topics/user-storage/simple-example.html">
            
                
                    <a href="../../topics/user-storage/simple-example.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.5.</b>
                        
                        Simple Read-Only, Lookup Example
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.6" data-path="topics/user-storage/configuration.html">
            
                
                    <a href="../../topics/user-storage/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.6.</b>
                        
                        Configuration Techniques
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.7" data-path="topics/user-storage/registration-query.html">
            
                
                    <a href="../../topics/user-storage/registration-query.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.7.</b>
                        
                        Add/Remove User and Query Capability interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.8" data-path="topics/user-storage/augmenting.html">
            
                
                    <a href="../../topics/user-storage/augmenting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.8.</b>
                        
                        Augmenting External Storage
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="9.9" data-path="topics/user-storage/import.html">
            
                
                    <a href="../../topics/user-storage/import.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.9.</b>
                        
                        Import Implementation Strategy
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.10" data-path="topics/user-storage/cache.html">
            
                
                    <a href="../../topics/user-storage/cache.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.10.</b>
                        
                        User Caches
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.11" data-path="topics/user-storage/javaee.html">
            
                
                    <a href="../../topics/user-storage/javaee.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.11.</b>
                        
                        Leveraging Java EE
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.12" data-path="topics/user-storage/rest.html">
            
                
                    <a href="../../topics/user-storage/rest.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.12.</b>
                        
                        REST Management API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.13" data-path="topics/user-storage/migration.html">
            
                
                    <a href="../../topics/user-storage/migration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.13.</b>
                        
                        Migrating from an Earlier User Federation SPI
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Server Developer Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <div class="sect2">
<h3 id="_import_implementation_strategy">Import Implementation Strategy</h3>
<div class="paragraph">
<p>When implementing a user storage provider, there&#x2019;s another strategy you can take.  Instead of using user federated storage,
you can create a user locally in the Keycloak built in user database and copy attributes from your external
store into this local copy.  There are a bunch of advantages to this approach.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak basically becomes a persistence user cache for your external store.  Once the user is imported
you&#x2019;ll no longer hit the external store thus taking load off of it.</p>
</li>
<li>
<p>If you are moving to Keycloak as your official user store and deprecating the old external store, you
can slowly migrate applications to use Keycloak.  When all applications have been migrated, unlink the
imported user, and retire the old legacy external store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some obvious disadvantages though to using an import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Looking up a user for the first time will require multiple updates to Keycloak database.  This can
be a big performance loss under load and put a lot of strain on the Keycloak database.  The user federated
storage approach will only store extra data as needed and may never be used depending on the capabilities of your external store.</p>
</li>
<li>
<p>With the import approach, you have to keep local keycloak storage and external storage in sync.  The User Storage SPI
has capability interfaces that you can implement to support synchronization, but this can quickly become painful and messy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To implement the import strategy you simply check to see first if the user has been imported locally.  If so return the
local user, if not create the user locally and import data from the external store.  You can also proxy the local user
so that most changes are automatically synchronized.</p>
</div>
<div class="paragraph">
<p>This will be a bit contrived, but we can extend our <code>PropertyFileUserStorageProvider</code> to take this approach.  We
begin first by modifying the <code>createAdapter()</code> method.</p>
</div>
<div class="listingblock java">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="highlight"><code>    protected UserModel createAdapter(RealmModel realm, String username) {
        UserModel local = session.userLocalStorage().getUserByUsername(username, realm);
        if (local == null) {
            local = session.userLocalStorage().addUser(realm, username);
            local.setFederationLink(model.getId());
        }
        return new UserModelDelegate(local) {
            @Override
            public void setUsername(String username) {
                String pw = (String)properties.remove(username);
                if (pw != null) {
                    properties.put(username, pw);
                    save();
                }
                super.setUsername(username);
            }
        };
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this method we call the <code>KeycloakSession.userLocalStorage()</code> method to obtain a reference to local Keycloak
user storage.  We see if the user is stored locally, if not, we add it locally.  Also note that we call
<code>UserModel.setFederationLink()</code> and pass in the id of the <code>ComponentModel</code> of our provider.  This sets a link between
the provider and the imported user.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When a user storage provider is removed, any user imported by it will also be removed.  This is one of the
      purposes of calling <code>UserModel.setFederationLink()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another thing to note is that if a local user is linked, your storage provider will still be delegated to for methods
that it implements from the <code>CredentialInputValidator</code> and <code>CredentialInputUpdater</code> interfaces.  Returning <code>false</code>
from a validation or update will just result in Keycloak seeing if it can validate or update using
local storage.</p>
</div>
<div class="paragraph">
<p>Also notice that we are proxying the local user using the <code>org.keycloak.models.utils.UserModelDelegate&apos; class.
This class is an implementation of `UserModel</code>.  Every method just delegates to the <code>UserModel</code> it was instantiated with.
We override the <code>setUsername()</code> method of this delegate class to synchronize automatically with the property file.
For your providers, you can use this to <em>intercept</em> other methods on the local <code>UserModel</code> to perform synchronization
with your extern store.  For example, get methods could make sure that the local store is in sync.   Set methods
keep external store in sync with local one.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If your provider is implementing the <code>UserRegistrationProvider</code> interface, your <code>removeUser()</code> method does not
      need to remove the user from local storage.  The runtime will automatically perform this operation.  Also
      note that <code>removeUser()</code> will be invoked before it is removed from local storage.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_importeduservalidation_interface">ImportedUserValidation Interface</h4>
<div class="paragraph">
<p>If you remember earlier in this chapter, we discussed how querying for a user worked.  Local storage is queried first,
if the user is found there, then the query ends.  This is a problem for our above implementation as we want
to proxy the local <code>UserModel</code> so that we can keep usernames in sync.  The User Storage SPI has a callback for whenever
a linked local user is loaded from the local database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">package</span> org.keycloak.storage.user;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ImportedUserValidation</span> </span>{
    <span class="hljs-comment">/**
     * If this method returns null, then the user in local storage will be removed
     *
     * <span class="hljs-doctag">@param</span> realm
     * <span class="hljs-doctag">@param</span> user
     * <span class="hljs-doctag">@return</span> null if user no longer valid
     */</span>
    <span class="hljs-function">UserModel <span class="hljs-title">validate</span><span class="hljs-params">(RealmModel realm, UserModel user)</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever a linked local user is loaded, if the user storage provider class implements this interface, then the
<code>validate()</code> method is called.  Here you can proxy the local user passed in as a parameter and return it.  That
new <code>UserModel</code> will be used.  You can also optionally do a check to see if the user exists still in the external store.
if <code>validate()</code> returns <code>null</code>, then the local user will be removed from the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_importsynchronization_interface">ImportSynchronization Interface</h4>
<div class="paragraph">
<p>With the import strategy you can see that it would be possible for the local user copy could get out of sync with
external storage.  For example, maybe a user has been removed from the external store.  The User Storage SPI has
an additional interface you can implement to deal with this.  <code>org.keycloak.storage.user.ImportSynchronization</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">package</span> org.keycloak.storage.user;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ImportSynchronization</span> </span>{
    <span class="hljs-function">SynchronizationResult <span class="hljs-title">sync</span><span class="hljs-params">(KeycloakSessionFactory sessionFactory, String realmId, UserStorageProviderModel model)</span></span>;
    <span class="hljs-function">SynchronizationResult <span class="hljs-title">syncSince</span><span class="hljs-params">(Date lastSync, KeycloakSessionFactory sessionFactory, String realmId, UserStorageProviderModel model)</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface is implemented by the provider factory.  Once this interface is implemented by the provider factory,
the admin console management page for the provider will show additional options.  There is a button that will allow
you to manually force a synchronization.  This invokes the <code>ImportSynchronization.sync()</code> method.  Also, some additional
configuration options will show up that allow you to automatically schedule a synchronization.  Automatic syncs invoke
the <code>syncSince()</code> method.</p>
</div>
</div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../topics/user-storage/augmenting.html" class="navigation navigation-prev " aria-label="Previous page: Augmenting External Storage"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../topics/user-storage/cache.html" class="navigation navigation-next " aria-label="Next page: User Caches"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-ungrey/ungrey.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"toggle-chapters":{},"ungrey":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Server Developer Guide -->
</html>
