<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Server Developer Guide -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Configuration Techniques | Server Developer Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../topics/user-storage/registration-query.html" />
    
    
    <link rel="prev" href="../../topics/user-storage/simple-example.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="9.6"
        data-chapter-title="Configuration Techniques"
        data-filepath="topics/user-storage/configuration.adoc"
        data-basepath="../.."
        data-revision="Wed Feb 08 2017 07:51:10 GMT+0100 (CET)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="topics/preface.html">
            
                
                    <a href="../../topics/preface.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="topics/admin-rest-api.html">
            
                
                    <a href="../../topics/admin-rest-api.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Admin REST API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="topics/themes.html">
            
                
                    <a href="../../topics/themes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Themes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="topics/custom-attributes.html">
            
                
                    <a href="../../topics/custom-attributes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Custom User Attributes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="topics/providers.html">
            
                
                    <a href="../../topics/providers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Service Provider Interfaces (SPI)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="topics/extensions.html">
            
                
                    <a href="../../topics/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Extending Server
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="topics/auth-spi.html">
            
                
                    <a href="../../topics/auth-spi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Authentication SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="topics/events.html">
            
                
                    <a href="../../topics/events.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Event Listener SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="topics/user-storage.html">
            
                
                    <a href="../../topics/user-storage.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        User Storage SPI
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="9.1" data-path="topics/user-storage/provider-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                        Provider Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="topics/user-storage/provider-capability-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-capability-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                        Provider Capability Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.3" data-path="topics/user-storage/model-interfaces.html">
            
                
                    <a href="../../topics/user-storage/model-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                        Model Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.4" data-path="topics/user-storage/packaging.html">
            
                
                    <a href="../../topics/user-storage/packaging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.4.</b>
                        
                        Packaging and Deployment
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.5" data-path="topics/user-storage/simple-example.html">
            
                
                    <a href="../../topics/user-storage/simple-example.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.5.</b>
                        
                        Simple Read-Only, Lookup Example
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="9.6" data-path="topics/user-storage/configuration.html">
            
                
                    <a href="../../topics/user-storage/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.6.</b>
                        
                        Configuration Techniques
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.7" data-path="topics/user-storage/registration-query.html">
            
                
                    <a href="../../topics/user-storage/registration-query.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.7.</b>
                        
                        Add/Remove User and Query Capability interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.8" data-path="topics/user-storage/augmenting.html">
            
                
                    <a href="../../topics/user-storage/augmenting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.8.</b>
                        
                        Augmenting External Storage
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.9" data-path="topics/user-storage/import.html">
            
                
                    <a href="../../topics/user-storage/import.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.9.</b>
                        
                        Import Implementation Strategy
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.10" data-path="topics/user-storage/cache.html">
            
                
                    <a href="../../topics/user-storage/cache.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.10.</b>
                        
                        User Caches
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.11" data-path="topics/user-storage/javaee.html">
            
                
                    <a href="../../topics/user-storage/javaee.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.11.</b>
                        
                        Leveraging Java EE
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.12" data-path="topics/user-storage/rest.html">
            
                
                    <a href="../../topics/user-storage/rest.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.12.</b>
                        
                        REST Management API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.13" data-path="topics/user-storage/migration.html">
            
                
                    <a href="../../topics/user-storage/migration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.13.</b>
                        
                        Migrating from an Earlier User Federation SPI
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Server Developer Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <div class="sect2">
<h3 id="_configuration_techniques">Configuration Techniques</h3>
<div class="paragraph">
<p>Our <code>PropertyFileUserStorageProvider</code> example is bit contrived.  It is hardcoded to a property file that is embedded
in the jar of the provider.  Not very useful at all.  We may want to make the location of this file configurable per
instance of the provider.  In other words, we may want to re-use this provider mulitple times in multiple different realms
and point to completely different user property files.  We&#x2019;ll also want to do this configuration within the admin
console UI.</p>
</div>
<div class="paragraph">
<p>The <code>UserStorageProviderFactory</code> has additional methods you can implement that deal with provider configuration.
You describe the variables you want to configure per provider and the admin console will automatically render
a generic input page to gather this configuration.  There&#x2019;s also callback methods to validate configuration
before it is saved, when a provider is created for the first time, and when it is updated.  <code>UserStorageProviderFactory</code>
inherits these methods from the <code>org.keycloak.component.ComponentFactory</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-function">List&lt;ProviderConfigProperty&gt; <span class="hljs-title">getConfigProperties</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">default</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title">validateConfiguration</span><span class="hljs-params">(KeycloakSession session, RealmModel realm, ComponentModel model)</span>
            <span class="hljs-keyword">throws</span> ComponentValidationException
    </span>{

    }

    <span class="hljs-function"><span class="hljs-keyword">default</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(KeycloakSession session, RealmModel realm, ComponentModel model)</span> </span>{

    }

    <span class="hljs-function"><span class="hljs-keyword">default</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title">onUpdate</span><span class="hljs-params">(KeycloakSession session, RealmModel realm, ComponentModel model)</span> </span>{

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ComponentFactory.getConfigProperties()</code> method returns a list of <code>org.keycloak.provider.ProviderConfigProperty</code>
instances.  These instances declare metadata that is needed to render and store each configuration variable of the
provider.</p>
</div>
<div class="sect3">
<h4 id="_configuration_example">Configuration Example</h4>
<div class="paragraph">
<p>Let&#x2019;s expand our <code>PropertyFileUserStorageProviderFactory</code> example to allow you to to point a provider instance to a specific
file on disk.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProviderFactory</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PropertyFileUserStorageProviderFactory</span>
                  <span class="hljs-keyword">implements</span> <span class="hljs-title">UserStorageProviderFactory</span>&lt;<span class="hljs-title">PropertyFileUserStorageProvider</span>&gt; </span>{

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;ProviderConfigProperty&gt; configMetadata;

    <span class="hljs-keyword">static</span> {
        configMetadata = ProviderConfigurationBuilder.create()
                .property().name(<span class="hljs-string">&quot;path&quot;</span>)
                .type(ProviderConfigProperty.STRING_TYPE)
                .label(<span class="hljs-string">&quot;Path&quot;</span>)
                .defaultValue(<span class="hljs-string">&quot;${jboss.server.config.dir}/example-users.properties&quot;</span>)
                .helpText(<span class="hljs-string">&quot;File path to properties file&quot;</span>)
                .<span class="hljs-keyword">default</span>
                .add().build();
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;ProviderConfigProperty&gt; <span class="hljs-title">getConfigProperties</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> configMetadata;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ProviderConfigurationBuilder</code> class is a great helper class to create a list of configuration properties.  Here
we specify a variable named <code>path</code> that is a string type.  In the admin console config page for this provider,
this config variable will be labed as <code>Path</code> and have a default value of <code>${jboss.server.config.dir}/example-users.properties</code>.
When you hover over the tooltip of this config option, it will display the help text <code>File path to properties file</code>.</p>
</div>
<div class="paragraph">
<p>The next thing we want to do is to verify that this file exists on disk.  We don&#x2019;t want to enable an instance of this
provider in the realm unless it points to a valid user property file.  To do this we implement the <code>validateConfiguration()</code>
method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateConfiguration</span><span class="hljs-params">(KeycloakSession session, RealmModel realm, ComponentModel config)</span>
                   <span class="hljs-keyword">throws</span> ComponentValidationException </span>{
        String fp = config.getConfig().getFirst(<span class="hljs-string">&quot;path&quot;</span>);
        <span class="hljs-keyword">if</span> (fp == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ComponentValidationException(<span class="hljs-string">&quot;user property file does not exist&quot;</span>);
        fp = EnvUtil.replace(fp);
        File file = <span class="hljs-keyword">new</span> File(fp);
        <span class="hljs-keyword">if</span> (!file.exists()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ComponentValidationException(<span class="hljs-string">&quot;user property file does not exist&quot;</span>);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>validateConfiguration()</code> method we get the config variable from the <code>ComponentModel</code> and we check to see
if that file exists on disk.  Notice that we use the <code>org.keycloak.common.util.EnvUtil.replace()`method.  With this method
any string that has `${}</code> within it will replace that with a system property value. The <code>${jboss.server.config.dir}</code>
string corresponds to the <code>configuration/</code> directory of our server and is really useful for this example.</p>
</div>
<div class="paragraph">
<p>Next thing we have to do is remove the old <code>init()</code> method. We do this because user property files are going to be
unique per provider instance.  We move this logic to the <code>create()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PropertyFileUserStorageProvider <span class="hljs-title">create</span><span class="hljs-params">(KeycloakSession session, ComponentModel model)</span> </span>{
        String path = model.getConfig().getFirst(<span class="hljs-string">&quot;path&quot;</span>);

        Properties props = <span class="hljs-keyword">new</span> Properties();
        <span class="hljs-keyword">try</span> {
            InputStream is = <span class="hljs-keyword">new</span> FileInputStream(path);
            props.load(is);
            is.close();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyFileUserStorageProvider(session, model, props);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This logic, is of course, is really inefficient as every different transaction will read the entire user property file from disk,
but hopefully this illustrates, in a simple way, how to hook in configuration variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configure_in_admin_console">Configure in Admin Console</h4>
<div class="paragraph">
<p>Now that the configuration is enabled, you can set the <code>path</code> variable when you configure the provider in the admin console.</p>
</div>
<div class="paragraph">
<div class="title">Configured Provider</div>
<p><span class="image"><img src="../../keycloak-images/storage-provider-with-config.png" alt="storage-provider-with-config.png"></span></p>
</div>
</div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../topics/user-storage/simple-example.html" class="navigation navigation-prev " aria-label="Previous page: Simple Read-Only, Lookup Example"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../topics/user-storage/registration-query.html" class="navigation navigation-next " aria-label="Next page: Add/Remove User and Query Capability interfaces"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-ungrey/ungrey.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"toggle-chapters":{},"ungrey":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Server Developer Guide -->
</html>
