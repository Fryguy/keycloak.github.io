<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Server Developer Guide -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Migrating from an Earlier User Federation SPI | Server Developer Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    
    <link rel="prev" href="../../topics/user-storage/rest.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="9.13"
        data-chapter-title="Migrating from an Earlier User Federation SPI"
        data-filepath="topics/user-storage/migration.adoc"
        data-basepath="../.."
        data-revision="Wed Feb 08 2017 07:51:10 GMT+0100 (CET)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="topics/preface.html">
            
                
                    <a href="../../topics/preface.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="topics/admin-rest-api.html">
            
                
                    <a href="../../topics/admin-rest-api.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Admin REST API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="topics/themes.html">
            
                
                    <a href="../../topics/themes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Themes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="topics/custom-attributes.html">
            
                
                    <a href="../../topics/custom-attributes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Custom User Attributes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="topics/providers.html">
            
                
                    <a href="../../topics/providers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Service Provider Interfaces (SPI)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="topics/extensions.html">
            
                
                    <a href="../../topics/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Extending Server
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="topics/auth-spi.html">
            
                
                    <a href="../../topics/auth-spi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Authentication SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="topics/events.html">
            
                
                    <a href="../../topics/events.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Event Listener SPI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="topics/user-storage.html">
            
                
                    <a href="../../topics/user-storage.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        User Storage SPI
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="9.1" data-path="topics/user-storage/provider-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                        Provider Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="topics/user-storage/provider-capability-interfaces.html">
            
                
                    <a href="../../topics/user-storage/provider-capability-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                        Provider Capability Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.3" data-path="topics/user-storage/model-interfaces.html">
            
                
                    <a href="../../topics/user-storage/model-interfaces.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.3.</b>
                        
                        Model Interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.4" data-path="topics/user-storage/packaging.html">
            
                
                    <a href="../../topics/user-storage/packaging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.4.</b>
                        
                        Packaging and Deployment
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.5" data-path="topics/user-storage/simple-example.html">
            
                
                    <a href="../../topics/user-storage/simple-example.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.5.</b>
                        
                        Simple Read-Only, Lookup Example
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.6" data-path="topics/user-storage/configuration.html">
            
                
                    <a href="../../topics/user-storage/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.6.</b>
                        
                        Configuration Techniques
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.7" data-path="topics/user-storage/registration-query.html">
            
                
                    <a href="../../topics/user-storage/registration-query.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.7.</b>
                        
                        Add/Remove User and Query Capability interfaces
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.8" data-path="topics/user-storage/augmenting.html">
            
                
                    <a href="../../topics/user-storage/augmenting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.8.</b>
                        
                        Augmenting External Storage
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.9" data-path="topics/user-storage/import.html">
            
                
                    <a href="../../topics/user-storage/import.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.9.</b>
                        
                        Import Implementation Strategy
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.10" data-path="topics/user-storage/cache.html">
            
                
                    <a href="../../topics/user-storage/cache.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.10.</b>
                        
                        User Caches
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.11" data-path="topics/user-storage/javaee.html">
            
                
                    <a href="../../topics/user-storage/javaee.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.11.</b>
                        
                        Leveraging Java EE
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.12" data-path="topics/user-storage/rest.html">
            
                
                    <a href="../../topics/user-storage/rest.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.12.</b>
                        
                        REST Management API
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="9.13" data-path="topics/user-storage/migration.html">
            
                
                    <a href="../../topics/user-storage/migration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.13.</b>
                        
                        Migrating from an Earlier User Federation SPI
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Server Developer Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <div class="sect2">
<h3 id="_migrating_from_an_earlier_user_federation_spi">Migrating from an Earlier User Federation SPI</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This chapter is only applicable if you have implemented a provider using the earlier (and now removed)
       User Federation SPI.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Keycloak version 2.4.0 and earlier there was a User Federation SPI. Red Hat Single Sign-On version 7.0, although unsupported, also had
this earlier SPI available as well. This earlier User Federation SPI has been removed from Keycloak version 2.5.0 and Red Hat Single Sign-On version 7.1.
However, if you have written a provider with this earlier SPI, this chapter discusses some strategies you can use to port it.</p>
</div>
<div class="sect3">
<h4 id="_import_vs_non_import">Import vs. Non-Import</h4>
<div class="paragraph">
<p>The earlier User Federation SPI required you to create a local copy of a user in the Keycloak&#x2019;s database
and import information from your external store to the local copy. However, this is no longer a requirement. You can still
port your earlier provider as-is, but you should consider whether a non-import strategy might be a better approach.</p>
</div>
<div class="paragraph">
<p>Advantages of the import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak basically becomes a persistence user cache for your external store. Once the user is imported
you&#x2019;ll no longer hit the external store, thus taking load off of it.</p>
</li>
<li>
<p>If you are moving to Keycloak as your official user store and deprecating the earlier external store, you
can slowly migrate applications to use Keycloak. When all applications have been migrated, unlink the
imported user, and retire the earlier legacy external store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some obvious disadvantages though to using an import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Looking up a user for the first time will require multiple updates to Keycloak database. This can
be a big performance loss under load and put a lot of strain on the Keycloak database. The user federated
storage approach will only store extra data as needed and might never be used depending on the capabilities of your external store.</p>
</li>
<li>
<p>With the import approach, you have to keep local keycloak storage and external storage in sync. The User Storage SPI
has capability interfaces that you can implement to support synchronization, but this can quickly become painful and messy.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_userfederationprovider_vs_userstorageprovider">UserFederationProvider vs. UserStorageProvider</h4>
<div class="paragraph">
<p>The first thing to notice is that <code>UserFederationProvider</code> was a complete interface. You implemented every method
in this interface. However, <code>UserStorageProvider</code> has instead broken up this interface into multiple capability interfaces that
you implement as needed.</p>
</div>
<div class="paragraph">
<p><code>UserFederationProvider.getUserByUsername()</code> and <code>getUserByEmail()</code> have exact equivalents in the new SPI. The difference
between the two is how you import. If you are going to continue with an import strategy, you no longer call
<code>KeycloakSession.userStorage().addUser()&apos; to create the user locally.  Instead you call `KeycloakSession.userLocalStorage().addUser()</code>.
The <code>userStorage()</code> method no longer exists.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider.validateAndProxy()</code> method has been moved to an optional capability interface, <code>ImportedUserValidation</code>.
You want to implement this interface if you are porting your earlier provider as-is.
Also note that in the earlier SPI, this method was called every time the user was accessed, even if the local user is in the cache.
In the later SPI, this method is only called when the local user is loaded from local storage. If the local user is cached,
then the <code>ImportedUserValidation.validate()</code> method is not called at all.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider.isValid()</code> method no longer exists in the later model.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider</code> methods <code>synchronizeRegistrations()</code>, <code>registerUser()</code>, and <code>removeUser()</code> have been
moved to the <code>UserRegistrationProvider</code> capability interface.  This new interface is optional to implement so if your
provider does not support creating and removing users, you don&#x2019;t have to implement it. If your earlier provider had switch
to toggle support for registering new users, this is supported in the new SPI, returning <code>null</code> from
<code>UserRegistrationProvider.addUser()</code> if the provider doesn&#x2019;t support adding users.</p>
</div>
<div class="paragraph">
<p>The earlier <code>UserFederationProvider</code> methods centered around credentials are now encapsulated in the <code>CredentialInputValidator</code>
and <code>CredentialInputUpdater</code> interfaces, which are also optional to implement depending on if you support validating or
updating credentials.  Credential management used to exist in <code>UserModel</code> methods. These also have been moved to the
<code>CredentialInputValidator</code> and <code>CredentialInputUpdater</code> interfaces.
One thing to note that if you do not implement the <code>CredentialInputUpdater</code> interface, then
any credentials provided by your provider can be overridden locally in Keycloak storage.  So if you want
your credentials to be read-only, implement the <code>CredentialInputUpdater.updateCredential()</code> method and
return a <code>ReadOnlyException</code>.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider</code> query methods such as <code>searchByAttributes()</code> and <code>getGroupMembers()</code> are now encapsulated
in an optional interface <code>UserQueryProvider</code>.  If you do not implement this interface, then users will not be viewable
in the admin console.  You&#x2019;ll still be able to login though.</p>
</div>
</div>
<div class="sect3">
<h4 id="_userfederationproviderfactory_vs_userstorageproviderfactory">UserFederationProviderFactory vs. UserStorageProviderFactory</h4>
<div class="paragraph">
<p>The synchronization methods in the earlier SPI are now encapsulated within an optional <code>ImportSynchronization</code> interface.
If you have implemented synchronization logic, then have your new <code>UserStorageProviderFactory</code> implement the
<code>ImportSynchronization</code> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_upgrading_to_a_new_model">Upgrading to a New Model</h4>
<div class="paragraph">
<p>The User Storage SPI instances are stored in a completely different set of relational tables or Mongo schema.  Keycloak
automatically runs a migration script. If any earlier User Federation providers are deployed for a realm, they are converted
to the later storage model as is, including the <code>id</code> of the data.  This migration will only happen if a User Storage provider exists
with the same provider ID (i.e., &quot;ldap&quot;, &quot;kerberos&quot;) as the earlier User Federation provider.</p>
</div>
<div class="paragraph">
<p>So, knowing this there are different approaches you can take.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can remove the earlier provider in your earlier Keycloak deployment. This will remove all local linked copies
of imported users.  Then, when you upgrade Keycloak, just deploy and configure your new provider for your realm.</p>
</li>
<li>
<p>The second option is to write your new provider making sure it has the same provider ID: <code>UserStorageProviderFactory.getId()</code>.
Make sure this provider is in the <code>deploy/</code> directory of the new Keycloak installation.  Boot the server, and have
the built-in migration script convert from the earlier data model to the later data model.  In this case all your earlier linked imported
users will work and be the same.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you have decided to get rid of the import strategy and rewrite your User Storage provider, we suggest that you remove the earlier provider
before upgrading Keycloak. This will remove linked local imported copies of any user you imported.</p>
</div>
</div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../topics/user-storage/rest.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: REST Management API"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-toggle-chapters/toggle.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-ungrey/ungrey.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"toggle-chapters":{},"ungrey":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Server Developer Guide -->
</html>
